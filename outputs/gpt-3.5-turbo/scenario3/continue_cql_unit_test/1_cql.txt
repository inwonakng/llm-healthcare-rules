```
library InsurancePolicyDocument

using FHIR version '4.0.1'

include FHIRHelpers version '4.0.1'

-- Named expressions based on the insurance policy document

-- Requirement 1: Medicare covers transplant drug therapy if Medicare helped pay for your organ transplant.
define medicareCoversTransplantDrugTherapy:
  exists ([Condition: Condition] |
    Condition.category.coding.exists(coding: Coding | coding.code = 'encounter')
    and Condition.code.coding.exists(coding: Coding | coding.code = 'organ-transplant')
    and Condition.payor.exists(payor: Reference | payor.reference = 'Medicare')
  )

-- Requirement 2: You must have Part A at the time of the covered transplant.
define hasPartAAtTransplant: 
  exists ([Encounter: Encounter] |
    Encounter.type.coding.exists(coding: Coding | coding.code = 'transplant')
    and Encounter.subject.exists(subject: Reference | subject.reference = 'Patient')
    and Encounter.subject.patient.exists(patient: Patient | patient.coverage.exists(coverage: Coverage | coverage.type.coding.exists(coding: Coding | coding.code = 'PartA')))
  )

-- Requirement 3: You must have Part B at the time you get immunosuppressive drugs.
define hasPartBAtImmunosuppressiveDrugs:
  exists ([MedicationRequest: MedicationRequest] |
    MedicationRequest.medicationCodeableConcept.coding.exists(coding: Coding | coding.code = 'immunosuppressive-drugs')
    and MedicationRequest.subject.exists(subject: Reference | subject.reference = 'Patient')
    and MedicationRequest.subject.patient.exists(patient: Patient | patient.coverage.exists(coverage: Coverage | coverage.type.coding.exists(coding: Coding | coding.code = 'PartB')))
  )

-- Requirement 4: Medicare drug coverage (Part D) covers immunosuppressive drugs if Part B doesn’t cover them.
define partDCoversImmunosuppressiveDrugs:
  exists ([MedicationRequest: MedicationRequest] |
    MedicationRequest.medicationCodeableConcept.coding.exists(coding: Coding | coding.code = 'immunosuppressive-drugs')
    and MedicationRequest.subject.exists(subject: Reference | subject.reference = 'Patient')
    and not MedicationRequest.subject.patient.exists(patient: Patient | patient.coverage.exists(coverage: Coverage | coverage.type.coding.exists(coding: Coding | coding.code = 'PartB')))
    and MedicationRequest.subject.patient.exists(patient: Patient | patient.coverage.exists(coverage: Coverage | coverage.type.coding.exists(coding: Coding | coding.code = 'PartD')))
  )

-- Requirement 5: If you have Original Medicare, you may join a Medicare drug plan to get Medicare drug coverage.
define joinMedicareDrugPlan:
  exists ([Patient: Patient] |
    Patient.coverage.exists(coverage: Coverage | coverage.type.coding.exists(coding: Coding | coding.code = 'PartA'))
    and Patient.coverage.exists(coverage: Coverage | coverage.type.coding.exists(coding: Coding | coding.code = 'PartB'))
    and not Patient.coverage.exists(coverage: Coverage | coverage.type.coding.exists(coding: Coding | coding.code = 'PartD'))
  )

-- Requirement 6: If you only have Medicare because of End-Stage Renal Disease (ESRD), your Medicare coverage, including immunosuppressive drug coverage, ends 36 months after a successful kidney transplant.
define esrdCoverageEndsAfterTransplant:
  exists ([Condition: Condition] |
    Condition.category.coding.exists(coding: Coding | coding.code = 'encounter')
    and Condition.code.coding.exists(coding: Coding | coding.code = 'kidney-transplant')
    and Condition.subject.exists(subject: Reference | subject.reference = 'Patient')
    and Condition.subject.patient.exists(patient: Patient | patient.coverage.exists(coverage: Coverage | coverage.type.coding.exists(coding: Coding | coding.code = 'PartA')))
    and Condition.onsetDateTime.exists(onsetDateTime: DateTime | onsetDateTime + 36 months >= Today())
  )

-- Requirement 7: Medicare offers a benefit that may help you if you lose Part A coverage 36 months after a kidney transplant and you don’t have certain types of other health coverage.
define medicareBenefitAfterCoverageLoss:
  exists ([Condition: Condition] |
    Condition.category.coding.exists(coding: Coding | coding.code = 'encounter')
    and Condition.code.coding.exists(coding: Coding | coding.code = 'kidney-transplant')
    and Condition.subject.exists(subject: Reference | subject.reference = 'Patient')
    and Condition.subject.patient.exists(patient: Patient | not patient.coverage.exists(coverage: Coverage | coverage.type.coding.exists(coding: Coding | coding.code = 'PartA')))
    and Condition.onsetDateTime.exists(onsetDateTime: DateTime | onsetDateTime + 36 months >= Today())
    and not patient.coverage.exists(coverage: Coverage | coverage.type.coding.exists(coding: Coding | coding.code in {'group-health-plan', 'TRICARE', 'Medicaid'}))
  )

-- Requirement 8: This benefit only covers your immunosuppressive drugs and no other items or services.
define benefitCoversImmunosuppressiveDrugsOnly:
  exists ([MedicationRequest: MedicationRequest] |
    MedicationRequest.medicationCodeableConcept.coding.exists(coding: Coding | coding.code = 'immunosuppressive-drugs')
    and MedicationRequest.subject.exists(subject: Reference | subject.reference = 'Patient')
    and MedicationRequest.subject.patient.exists(patient: Patient | not patient.coverage.exists(coverage: Coverage | coverage.type.coding.exists(coding: Coding | coding.code = 'PartA')))
    and MedicationRequest.onsetDateTime.exists(onsetDateTime: DateTime | onsetDateTime + 36 months >= Today())
    and not MedicationRequest.contained.exists(contained: Resource | contained.resourceType = 'Coverage')
  )

-- Requirement 9: It isn’t a substitute for full health coverage.
define notSubstituteForFullCoverage:
  exists ([Condition: Condition] |
    Condition.category.coding.exists(coding: Coding | coding.code = 'encounter')
    and Condition.code.coding.exists(coding: Coding | coding.code = 'kidney-transplant')
    and Condition.subject.exists(subject: Reference | subject.reference = 'Patient')
    and Condition.subject.patient.exists(patient: Patient | not patient.coverage.exists(coverage: Coverage | coverage.type.coding.exists(coding: Coding | coding.code = 'PartA')))
    and Condition.onsetDateTime.exists(onsetDateTime: DateTime | onsetDateTime + 36 months >= Today())
    and not MedicationRequest.contained.exists(contained: Resource | contained.resourceType = 'Coverage')
    and not MedicationRequest.contained.exists(contained: Resource | contained.resourceType = 'ServiceRequest')
  )

-- Requirement 10: If you qualify, you can sign up for this benefit any time after your Part A coverage ends.
define signUpAfterPartACoverageEnds:
  exists ([Condition: Condition] |
    Condition.category.coding.exists(coding: Coding | coding.code = 'encounter')
    and Condition.code.coding.exists(coding: Coding | coding.code = 'kidney-transplant')
    and Condition.subject.exists(subject: Reference | subject.reference = 'Patient')
    and Condition.subject.patient.exists(patient: Patient | not patient.coverage.exists(coverage: Coverage | coverage.type.coding.exists(coding: Coding | coding.code = 'PartA')))
    and Condition.onsetDateTime.exists(onsetDateTime: DateTime | onsetDateTime + 36 months >= Today())
    and not MedicationRequest.contained.exists(contained: Resource | contained.resourceType = 'Coverage')
    and not MedicationRequest.contained.exists(contained: Resource | contained.resourceType = 'ServiceRequest')
    and Today() > Condition.onsetDateTime + 36 months
  )

-- Requirement 11: To sign up, call Social Security at 1-877-465-0355. TTY users can call 1-800-325-0788.
define signUpContactInformation:
  'Call Social Security at 1-877-465-0355. TTY users can call 1-800-325-0788.'

-- Requirement 12: In 2023, the monthly premium for the immunosuppressive drug benefit is $97.10*.
define monthlyPremium2023: 97.10

-- Requirement 13: In 2023, there is a $226 deductible for the immunosuppressive drug benefit.
define deductible2023: 226

-- Requirement 14: Once you've met the deductible, you'll pay 20% of the Medicare-approved amount for your immunosuppressive drugs.
define paymentAfterDeductible:
  exists ([MedicationRequest: MedicationRequest] |
    MedicationRequest.medicationCodeableConcept.coding.exists(coding: Coding | coding.code = 'immunosuppressive-drugs')
    and MedicationRequest.subject.exists(subject: Reference | subject.reference = 'Patient')
    and MedicationRequest.subject.patient.exists(patient: Patient | not patient.coverage.exists(coverage: Coverage | coverage.type.coding.exists(coding: Coding | coding.code = 'PartA')))
    and MedicationRequest.onsetDateTime.exists(onsetDateTime: DateTime | onsetDateTime + 36 months >= Today())
    and MedicationRequest.dispenseRequest.exists(dispenseRequest: MedicationRequest.DispenseRequest | dispenseRequest.quantity.exists(quantity: Quantity | quantity.unit = 'Medicare-approved amount'))
    and MedicationRequest.dispenseRequest.exists(dispenseRequest: MedicationRequest.DispenseRequest | dispenseRequest.quantity.exists(quantity: Quantity | quantity.value = 20))
  )

end library
```
```